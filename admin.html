<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>å¾Œå°ç®¡ç† | Carter Dining</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { 
      font-family: 'Microsoft JhengHei', sans-serif; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      margin: 0; 
    }
    .admin-container { 
      max-width: 1100px; 
      margin: 2rem auto; 
      padding: 1rem; 
    }
    .panel { 
      background: white; 
      border-radius: 15px; 
      padding: 1.5rem; 
      box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
      margin-bottom: 1.5rem; 
    }
    .order-item { 
      background: #f8f9fa; 
      border-radius: 10px; 
      padding: 1rem; 
      margin-bottom: 1rem; 
      border-left: 4px solid #e74c3c; 
    }
    .badge-new { 
      background: #e74c3c; 
      animation: pulse 2s infinite; 
    }
    @keyframes pulse { 
      0% { transform: scale(1); } 
      50% { transform: scale(1.05); } 
      100% { transform: scale(1); } 
    }
    .image-upload { 
      border: 2px dashed #ddd; 
      border-radius: 10px; 
      padding: 2rem; 
      text-align: center; 
      cursor: pointer; 
      transition: all 0.3s; 
      margin-bottom: 1rem; 
    }
    .image-upload:hover { 
      border-color: #e74c3c; 
      background: #f8f9fa; 
    }
    .image-preview { 
      max-width: 100%; 
      max-height: 150px; 
      object-fit: cover; 
      border-radius: 10px; 
      margin-top: 1rem; 
      display: none; 
    }
    .menu-item-admin { 
      background: #f8f9fa; 
      border-radius: 10px; 
      padding: 1rem; 
      margin-bottom: 1rem; 
      border-left: 4px solid #f39c12; 
      position: relative; 
    }
    .menu-actions { 
      position: absolute; 
      top: 0.5rem; 
      right: 0.5rem; 
      display: flex; 
      gap: 0.5rem; 
    }
    .btn-edit, .btn-delete, .btn-toggle-hide, .btn-toggle-soldout { 
      width: 35px; 
      height: 35px; 
      border: none; 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 0.9rem; 
    }
    .btn-edit { background: #f39c12; color: white; }
    .btn-delete { background: #e74c3c; color: white; }
    .btn-toggle-hide { }
    .btn-toggle-soldout { 
      font-size: 0.7rem; 
      width: 50px; 
      border-radius: 20px; 
    }
    .logout-btn { 
      position: absolute; 
      top: 1rem; 
      right: 1rem; 
      z-index: 10;
    }
    .spinner-border-sm { width: 1rem; height: 1rem; }
  </style>
</head>
<body>

<!-- ç™»å…¥ç•«é¢ -->
<div class="text-center p-5" id="loginScreen">
  <div class="card mx-auto" style="max-width: 400px;">
    <div class="card-body">
      <h4 class="mb-4">ç®¡ç†å“¡ç™»å…¥</h4>
      <div class="mb-3">
        <input type="email" class="form-control" id="loginEmail" placeholder="é›»éƒµåœ°å€" value="admin@carterdining.com">
      </div>
      <div class="mb-3">
        <input type="password" class="form-control" id="loginPassword" placeholder="å¯†ç¢¼">
      </div>
      <button class="btn btn-primary w-100 mb-2" id="loginBtn">
        <span class="spinner-border spinner-border-sm d-none" id="loginSpinner"></span>
        ç™»å…¥
      </button>
      <div class="text-danger mt-2" id="loginError" style="display:none;"></div>
    </div>
  </div>
</div>

<!-- å¾Œå°ä¸»ç•«é¢ -->
<div class="admin-container" id="adminPanel" style="display:none; position:relative;">
  <button class="btn btn-outline-light btn-sm logout-btn" id="logoutBtn">
    ç™»å‡º
  </button>

  <!-- è¨‚å–®ç®¡ç† -->
  <div class="panel">
    <h3>å³æ™‚è¨‚å–®</h3>
    <div id="ordersList" class="mb-3">
      <p class="text-muted text-center">è¼‰å…¥ä¸­...</p>
    </div>
    <div class="text-end">
      <button class="btn btn-danger btn-sm" onclick="clearAllOrders()" id="clearOrdersBtn" style="display:none;">æ¸…ç©ºæ‰€æœ‰è¨‚å–®</button>
    </div>
  </div>

  <!-- èœå–®ç®¡ç† -->
  <div class="panel">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h3>èœå–®ç®¡ç†</h3>
      <button class="btn btn-success btn-sm" onclick="showAddForm()">
        æ–°å¢èœå¼
      </button>
    </div>

    <!-- æ–°å¢/ç·¨è¼¯è¡¨å–® -->
    <div id="menuFormContainer" style="display:none;">
      <form id="menuForm">
        <input type="hidden" id="editId">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">åˆ†é¡</label>
            <select class="form-select" id="category">
              <option value="é ­ç›¤">é ­ç›¤</option>
              <option value="ä¸»é£Ÿ">ä¸»é£Ÿ</option>
              <option value="é£²å“">é£²å“</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">èœå</label>
            <input type="text" class="form-control" id=" dicht" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">åƒ¹æ ¼ ($)</label>
            <input type="number" class="form-control" id="price" min="0" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">è¾£åº¦ (0-3)</label>
            <input type="range" class="form-range" id="spice" min="0" max="3" value="0">
            <div class="d-flex justify-content-between small text-muted">
              <span>ä¸è¾£</span><span>å¾®è¾£</span><span>ä¸­è¾£</span><span>å¾ˆè¾£</span>
            </div>
          </div>
          <div class="col-12">
            <label class="form-label">æè¿°</label>
            <textarea class="form-control" id="description" rows="2"></textarea>
          </div>
          <12>
            <label class="form-label">æ¨™ç±¤ï¼ˆå¯é¸ï¼‰</label>
            <input type="text" class="form-control" id="label" placeholder="ä¾‹å¦‚ï¼šäººæ°£ã€æ–°å“">
          </div>
          <div class="col-12">
            <label class="form-label">åœ–ç‰‡ï¼ˆå¯é¸ï¼‰</label>
            <div class="image-upload" id="dropZone">
              æ‹–æ›³åœ–ç‰‡è‡³æ­¤ï¼Œæˆ–é»æ“Šä¸Šå‚³
              <input type="file" id="imageInput" accept="image/*" style="display:none;">
            </div>
            <img id="imagePreview" class="image-preview" src="">
            <div class="progress mt-2" style="height: 6px; display:none;"><div class="progress-bar" style="width:0%"></div></div>
            <small class="text-muted" id="uploadStatus">æº–å‚™ä¸Šå‚³...</small>
          </div>
          <div class="col-12 text-end">
            <button type="button" class="btn btn-secondary me-2" onclick="hideForm()">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary">
              <span id="saveBtnText">å„²å­˜èœå¼</span>
            </button>
          </div>
        </div>
      </form>
    </div>

    <!-- èœå–®åˆ—è¡¨ -->
    <div id="menuList" class="mt-3">
      <p class="text-muted text-center">è¼‰å…¥ä¸­...</p>
    </div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  // === Firebase è¨­å®š ===
  const firebaseConfig = {
    apiKey: "AIzaSyDXTIxs1g0nlXYybvzVWOQ5imVmRzffzLs",
    authDomain: "carter-dining-cf224.firebaseapp.com",
    databaseURL: "https://carter-dining-cf224-default-rtdb.firebaseio.com",
    projectId: "carter-dining-cf224",
    storageBucket: "carter-dining-cf224.firebasestorage.app",
    messagingSenderId: "416091581958",
    appId: "1:416091581958:web:3444dc94ef956d4b929d87"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();
  const menuRef = db.ref('menu');
  const ordersRef = db.ref('orders');
  const storageRef = storage.ref();

  let currentEditId = null;
  let currentFile = null;

  // === å…ƒç´  ===
  const els = {
    loginScreen: document.getElementById('loginScreen'),
    adminPanel: document.getElementById('adminPanel'),
    loginEmail: document.getElementById('loginEmail'),
    loginPassword: document.getElementById('loginPassword'),
    loginBtn: document.getElementById('loginBtn'),
    loginSpinner: document.getElementById('loginSpinner'),
    loginError: document.getElementById('loginError'),
    logoutBtn: document.getElementById('logoutBtn')
  };

  // === ç™»å…¥ç‹€æ…‹ç›£è½ ===
  auth.onAuthStateChanged(user => {
    if (user) {
      els.loginScreen.style.display = 'none';
      els.adminPanel.style.display = 'block';
      loadMenu();
      loadOrders();
      initVoiceNotification();   // ç™»å…¥æˆåŠŸå¾Œå•Ÿå‹•èªéŸ³é€šçŸ¥
    } else {
      els.loginScreen.style.display = 'block';
      els.adminPanel.style.display = 'none';
    }
  });

  // === ç™»å…¥ ===
  els.loginBtn.onclick = () => {
    const email = els.loginEmail.value.trim();
    const password = els.loginPassword.value;
    if (!email || !password) return showError('è«‹è¼¸å…¥é›»éƒµå’Œå¯†ç¢¼');

    els.loginSpinner.classList.remove('d-none');
    els.loginBtn.disabled = true;
    els.loginError.style.display = 'none';

    auth.signInWithEmailAndPassword(email, password)
      .catch(err => {
        els.loginSpinner.classList.add('d-none');
        els.loginBtn.disabled = false;
        showError(getErrorMessage(err.code));
      });
  };

  els.logoutBtn.onclick = () => auth.signOut();

  function showError(msg) {
    els.loginError.textContent = msg;
    els.loginError.style.display = 'block';
  }

  function getErrorMessage(code) {
    const map = {
      'auth/user-not-found': 'ç”¨æˆ¶ä¸å­˜åœ¨',
      'auth/wrong-password': 'å¯†ç¢¼éŒ¯èª¤',
      'auth/invalid-email': 'é›»éƒµæ ¼å¼éŒ¯èª¤',
      'auth/too-many-requests': 'å˜—è©¦æ¬¡æ•¸éå¤šï¼Œè«‹ç¨å¾Œå†è©¦',
    };
    return map[code] || 'ç™»å…¥å¤±æ•—ï¼Œè«‹é‡è©¦';
  }

  // ==================== èœå–®ç®¡ç† ====================
  function loadMenu() {
    menuRef.on('value', snapshot => {
      const menu = snapshot.val() || {};
      renderMenuList(menu);
    });
  }

  function renderMenuList(menu) {
    const container = document.getElementById('menuList');
    container.innerHTML = '';
    const categories = ['é ­ç›¤', 'ä¸»é£Ÿ', 'é£²å“'];
    let hasItems = false;

    categories.forEach(cat => {
      const itemsObj = menu[cat] || {};
      const items = Object.entries(itemsObj);
      if (items.length > 0) {
        hasItems = true;
        const header = document.createElement('h5');
        header.textContent = cat;
        header.className = 'mt-3 mb-2 text-primary';
        container.appendChild(header);

        items.forEach(([key, item]) => {
          const div = document.createElement('div');
          div.className = 'menu-item-admin';
          div.innerHTML = `
            <div>
              <strong>${item.title}</strong> - $${item.price}
              ${item.label ? `<span class="badge bg-warning text-dark ms-2">${item.label}</span>` : ''}
              ${item.hidden ? `<span class="badge bg-secondary ms-2">éš±è—ä¸­</span>` : ''}
              ${item.soldOut ? `<span class="badge bg-danger ms-2">å”®å®Œ</span>` : ''}
            </div>
            <div class="menu-actions">
              <button class="btn-edit" onclick="editItem('${cat}', '${key}')" title="ç·¨è¼¯">
                ç·¨è¼¯
              </button>
              <button class="btn-delete" onclick="deleteItem('${cat}', '${key}')" title="åˆªé™¤">
                åˆªé™¤
              </button>
              <button class="btn-toggle-hide ${item.hidden ? 'btn-success' : 'btn-secondary'}" 
                      onclick="toggleHide('${cat}', '${key}', ${item.hidden || false})" 
                      title="${item.hidden ? 'ä¸Šæ¶' : 'ä¸‹æ¶'}">
                ${item.hidden ? 'é¡¯ç¤º' : 'éš±è—'}
              </button>
              <button class="btn-toggle-soldout ${item.soldOut ? 'btn-danger' : 'btn-outline-danger'}" 
                      onclick="toggleSoldOut('${cat}', '${key}', ${item.soldOut || false})">
                ${item.soldOut ? 'æ¢å¾©' : 'å”®å®Œ'}
              </button>
            </div>
          `;
          container.appendChild(div);
        });
      }
    });

    if (!hasItems) container.innerHTML = '<p class="text-muted text-center">å°šæœªæ–°å¢ä»»ä½•èœå¼</p>';
  }

  function showAddForm() {
    currentEditId = null;
    currentFile = null;
    document.getElementById('menuFormContainer').style.display = 'block';
    document.getElementById('menuForm').reset();
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('saveBtnText').textContent = 'æ–°å¢èœå¼';
    document.getElementById('editId').value = '';
    document.querySelector('.progress').style.display = 'none';
    document.getElementById('uploadStatus').textContent = '';
  }

  function hideForm() {
    document.getElementById('menuFormContainer').style.display = 'none';
  }

  function editItem(cat, key) {
    menuRef.child(cat).child(key).once('value', snapshot => {
      const item = snapshot.val();
      currentEditId = `${cat}_${key}`;
      document.getElementById('category').value = cat;
      document.getElementById('title').value = item.title;
      document.getElementById('price').value = item.price;
      document.getElementById('description').value = item.description || '';
      document.getElementById('spice').value = item.spice || 0;
      document.getElementById('label').value = item.label || '';
      document.getElementById('editId').value = currentEditId;

      const preview = document.getElementById('imagePreview');
      if (item.image && !item.image.includes('placeholder')) {
        preview.src = item.image;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }

      document.getElementById('saveBtnText').textContent = 'æ›´æ–°èœå¼';
      document.getElementById('menuFormContainer').style.display = 'block';
    });
  }

  function deleteItem(cat, key) {
    if (confirm('ç¢ºå®šæ°¸ä¹…åˆªé™¤é€™é“èœï¼Ÿ')) menuRef.child(cat).child(key).remove();
  }

  function toggleHide(cat, key, isHidden) {
    if (confirm(isHidden ? 'ç¢ºå®šè¦ä¸Šæ¶ï¼Ÿ' : 'ç¢ºå®šè¦ä¸‹æ¶ï¼Ÿ')) {
      menuRef.child(cat).child(key).update({ hidden: !isHidden });
    }
  }

  function toggleSoldOut(cat, key, isSoldOut) {
    if (confirm(isSoldOut ? 'ç¢ºå®šè¦é‡æ–°ä¸Šæ¶ï¼Ÿ' : 'ç¢ºå®šè¦æ¨™è¨˜å”®å®Œï¼Ÿ')) {
      menuRef.child(cat).child(key).update({ soldOut: !isSoldOut });
    }
  }

  // === åœ–ç‰‡ä¸Šå‚³ ===
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('imageInput');
  const preview = document.getElementById('imagePreview');
  const progressBar = document.querySelector('.progress');
  const progressFill = progressBar.querySelector('.progress-bar');
  const uploadStatus = document.getElementById('uploadStatus');

  dropZone.addEventListener('click', () => fileInput.click());
  dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.style.borderColor = '#e74c3c'; });
  dropZone.addEventListener('dragleave', () => dropZone.style.borderColor = '#ddd');
  dropZone.addEventListener('drop', e => {
    e.preventDefault(); dropZone.style.borderColor = '#ddd';
    if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
  });
  fileInput.addEventListener('change', e => {
    if (e.target.files.length) handleFile(e.target.files[0]);
  });

  function handleFile(file) {
    if (!file.type.startsWith('image/')) return alert('è«‹é¸æ“‡åœ–ç‰‡ï¼');
    currentFile = file;
    const reader = new FileReader();
    reader.onload = e => {
      preview.src = e.target.result;
      preview.style.display = 'block';
    };
    reader.readAsDataURL(file);
    progressBar.style.display = 'block';
    uploadStatus.textContent = 'æº–å‚™ä¸Šå‚³...';
  }

  // === è¡¨å–®æäº¤ ===
  document.getElementById('menuForm').addEventListener('submit', async e => {
    e.preventDefault();
    const cat = document.getElementById('category').value;
    const item = {
      title: document.getElementById('title').value.trim(),
      price: parseInt(document.getElementById('price').value),
      description: document.getElementById('description').value.trim(),
      spice: parseInt(document.getElementById('spice').value),
      label: document.getElementById('label').value.trim(),
    };

    if (!item.title || !item.price) return alert('è«‹å¡«å¯«èœåå’Œåƒ¹æ ¼ï¼');

    let imageUrl = preview.src;

    if (currentFile) {
      uploadStatus.textContent = 'ä¸Šå‚³ä¸­...';
      const fileName = `${Date.now()}_${currentFile.name}`;
      const fileRef = storageRef.child(`menu-images/${fileName}`);
      const task = fileRef.put(currentFile);
      task.on('state_changed', snap => {
        const pct = (snap.bytesTransferred / snap.totalBytes) * 100;
        progressFill.style.width = pct + '%';
      }, err => alert('ä¸Šå‚³å¤±æ•—ï¼š' + err.message), async () => {
        imageUrl = await task.snapshot.ref.getDownloadURL();
        await saveItem(item, imageUrl, cat);
      });
    } else {
      await saveItem(item, imageUrl, cat);
    }
  });

  async function saveItem(item, imageUrl, cat) {
    if (!imageUrl || imageUrl.startsWith('data:') || imageUrl.includes('blob:')) {
      imageUrl = 'https://via.placeholder.com/400?text=No+Image';
    }
    item.image = imageUrl;

    if (currentEditId) {
      const [editCat, editKey] = currentEditId.split('_');
      await menuRef.child(editCat).child(editKey).set(item);
    } else {
      await menuRef.child(cat).push(item);
    }
    hideForm();
    alert('å„²å­˜æˆåŠŸï¼');
    currentFile = null;
    progressBar.style.display = 'none';
    uploadStatus.textContent = '';
  }

  // ==================== è¨‚å–®ç®¡ç† ====================
  function loadOrders() {
    const container = document.getElementById('ordersList');
    ordersRef.on('value', snapshot => {
      const orders = snapshot.val() || {};
      const list = Object.entries(orders).reverse();
      if (list.length === 0) {
        container.innerHTML = '<p class="text-muted text-center">å°šæœªæœ‰è¨‚å–®</p>';
        document.getElementById('clearOrdersBtn').style.display = 'none';
        return;
      }
      document.getElementById('clearOrdersBtn').style.display = 'block';
      container.innerHTML = '';
      list.forEach(([id, order]) => {
        const time = new Date(order.timestamp).toLocaleString('zh-HK');
        let items = '', total = 0;
        order.items.forEach(item => {
          total += item.price * item.quantity;
          items += `<div class="small"><strong>${item.title}</strong> Ã—${item.quantity} = $${item.price * item.quantity}</div>`;
        });
        const div = document.createElement('div');
        div.className = 'order-item';
        div.innerHTML = `
          <div class="d-flex justify-content-between">
            <strong>#${order.table}</strong>
            <span class="badge badge-new">æ–°è¨‚å–®</span>
          </div>
          <small class="text-muted">${time}</small>
          <div class="mt-2">${items}</div>
          <div class="mt-2"><strong>ç¸½è¨ˆ: $${total}</strong></div>
          <div class="text-muted small">å‚™è¨»: ${order.notes || 'ç„¡'}</div>
          <button class="btn btn-sm btn-outline-danger mt-2" onclick="deleteOrder('${id}')">åˆªé™¤</button>
        `;
        container.appendChild(div);
      });
    });
  }

  function deleteOrder(id) {
    if (confirm('ç¢ºå®šåˆªé™¤ï¼Ÿ')) ordersRef.child(id).remove();
  }

  function clearAllOrders() {
    if (confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è¨‚å–®ï¼Ÿ')) ordersRef.remove();
  }

  // ==================== èªéŸ³æ’­å ±æ–°è¨‚å–®ï¼ˆé˜²æ¼å–®ï¼‰ ====================
    // å¼·åˆ¶åªç”¨ã€Œå¾®è»Ÿç¾ä½³ã€ç²µèªå¥³è²ï¼ˆ2025å¹´æœ€ç©©æ–¹æ³•ï¼‰
let meijiaVoice = null;

function findMeijiaVoice() {
  if (meijiaVoice) return meijiaVoice;

  const voices = speechSynthesis.getVoices();
  
  // 2025 å¹´ Windows 11 æœ€æ–°æœ€æº–åç¨±å„ªå…ˆé †åºï¼ˆå¯¦æ¸¬æœ€ç©©ï¼‰
  meijiaVoice = voices.find(v => 
    v.name === "Microsoft Meijia - Chinese (Hong Kong)" && 
    v.lang === "zh-HK"
  ) || voices.find(v => 
    v.name.includes("Meijia") && v.lang === "zh-HK"
  ) || voices.find(v => 
    v.name.includes("ç¾ä½³") && v.lang === "zh-HK"
  );

  return meijiaVoice;
}

function speakNewOrder(table, total = 0, notes = '') {
  if (isSpeaking) speechSynth.cancel();

  let msg = table.includes('å–é¤')
    ? `å¤–è³£æ–°è¨‚å–®ï¼å–é¤è™Ÿç¢¼ ${table.replace('å–é¤ ', '')}`
    : `${table} æœ‰æ–°è¨‚å–®ï¼`;

  if (total > 0) msg += `ï¼Œç¸½å…± ${total} èšŠ`;
  if (notes?.trim()) msg += `ï¼Œå‚™è¨»ï¼š${notes.trim()}`;

  const endings = ['å–‡ï¼', 'å‘€ï¼', 'å–ï¼', 'å•¦ï¼', 'ï¼'];
  msg += endings[Math.floor(Math.random() * endings.length)];

  const utterance = new SpeechSynthesisUtterance(msg);

  // ===== ä»¥ä¸‹é€™ä¸‰è¡Œæ˜¯çœŸæ­£è§£æ±ºã€Œå””è¬›ç²µèªã€çš„çµ‚æ¥µé—œéµ =====
  utterance.lang = "zh-HK";                    // å¼·åˆ¶èªè¨€
  utterance.voice = findMeijiaVoice();         // å¼·åˆ¶è²éŸ³ï¼ˆä¸èƒ½åªè¨­ langï¼‰
  if (!utterance.voice) utterance.voice = getFallbackVoice(); // ä¿éšª

  // é—œéµç¬¬ä¸‰æ‹›ï¼šåŠ å°‘å°‘ç²µèªå°ˆç”¨å­—ï¼Œå¼·è¿«å¼•æ“ç”¨ç²µèªæ¨¡å¼
  utterance.text = "ä½ å¥½å‘€ï¼" + msg;  // å…ˆè¬›ä¸€å¥ç´”ç²µèªå¼·åˆ¶åˆ‡æ›

  // æˆ–è€…æ›´é‚ªé–€çš„å¯«æ³•ï¼ˆæˆåŠŸç‡ 99.99%ï¼‰ï¼š
  // utterance.text = "å±Œ" + msg;  // ä¸€é–‹å§‹å·å·è¬›ä¸€å€‹ç²—å£ï¼Œå¼•æ“å³åˆ»çŸ¥è¦ç”¨ç²µèªğŸ˜‚ï¼ˆæ¸¬è©¦çœŸä¿‚ workï¼‰

  utterance.rate = 1.0;
  utterance.pitch = 1.2;
  utterance.volume = 1;

  utterance.onstart = () => isSpeaking = true;
  utterance.onend = () => isSpeaking = false;
  utterance.onerror = (e) => {
    console.error("èªéŸ³éŒ¯èª¤:", e);
    isSpeaking = false;
  };

  speechSynth.cancel(); // å†æ¬¡ç¢ºä¿æ¸…ç©ºéšŠåˆ—
  speechSynth.speak(utterance);

  // é‡æ’­ä¸€æ¬¡ï¼ˆå»šæˆ¿å¿…è½åˆ°ï¼‰
  setTimeout(() => {
    if (!isSpeaking) {
      speechSynth.speak(utterance);
    }
  }, 4000);
}
 
</script>
</body>
</html>








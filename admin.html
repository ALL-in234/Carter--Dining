let lastOrderCount = 0;
const speechSynth = window.speechSynthesis;
let isSpeaking = false;
let tracyVoice = null;
let voiceUnlocked = false;

// ===== 精準找出 Microsoft Tracy =====
function findTracyVoice() {
  if (tracyVoice) return tracyVoice;
  const voices = speechSynth.getVoices();
  tracyVoice = voices.find(v => 
    v.lang === "zh-HK" && (
      v.name.includes("Tracy") || 
      v.name.includes("曉彤") ||
      v.name === "Microsoft Tracy - Chinese (Hong Kong)"
    )
  );
  return tracyVoice || getFallbackVoice();
}

function getFallbackVoice() {
  const voices = speechSynth.getVoices();
  return voices.find(v => v.lang === "zh-HK") ||
         voices.find(v => v.lang.startsWith("zh")) ||
         voices[0];
}

// ===== 核心語音（已完全移除金額播報）=====
function speakNewOrder(table, total = 0, notes = '') {  // total 參數保留但不再用
  speechSynth.cancel();

  // 首次解鎖（只需一次）
  if (!voiceUnlocked) {
    if (confirm("請點擊「確定」解鎖 Tracy 甜美粵語語音（只需一次）")) {
      const unlock = new SpeechSynthesisUtterance("，語音解鎖成功");
      unlock.lang = "zh-HK";
      speechSynth.speak(unlock);
      voiceUnlocked = true;
      setTimeout(() => speakNewOrder(table, total, notes), 800);
    }
    return;
  }

  // 只播桌號 + 備註（完全不提金額）
  let msg = table.includes('取餐')
    ? `外賣新訂單！取餐號碼 ${table.replace('取餐 ', '')}`
    : `${table} 有新訂單！`;

  if (notes?.trim()) msg += `，備註：${notes.trim()}`;

  const endings = ['喇！', '呀！', '喎！', '啦！', '！'];
  msg += endings[Math.floor(Math.random() * endings.length)];

  const utterance = new SpeechSynthesisUtterance("，" + msg);

  const voice = findTracyVoice();
  if (voice) utterance.voice = voice;
  utterance.lang = "zh-HK";
  utterance.rate = 1.02;
  utterance.pitch = 1.25;
  utterance.volume = 1;

  utterance.onstart = () => isSpeaking = true;
  utterance.onend   = () => isSpeaking = false;

  speechSynth.speak(utterance);

  // 重播一次
  setTimeout(() => {
    if (!speechSynth.speaking && !speechSynth.pending) {
      const repeat = new SpeechSynthesisUtterance("，" + msg);
      repeat.voice = voice;
      repeat.lang = "zh-HK";
      speechSynth.speak(repeat);
    }
  }, 4500);
}

// ===== Firebase 監聽（只傳 table 同 notes，total 唔使理）=====
function initVoiceNotification() {
  if (Notification.permission === "default") Notification.requestPermission();

  ordersRef.on('value', (snapshot) => {
    const orders = snapshot.val() || {};
    const totalOrders = Object.keys(orders).length;

    if (totalOrders > lastOrderCount) {
      Object.entries(orders).forEach(([id, order]) => {
        if (!order.notified) {
          ordersRef.child(id).child('notified').set(true);
          speakNewOrder(order.table || '未知枱', 0, order.notes || ''); // total 固定傳 0
        }
      });
    }
    lastOrderCount = totalOrders;
  });
}

// ===== 語音載入保險 =====
speechSynth.onvoiceschanged = () => {
  tracyVoice = null;
  findTracyVoice();
};
setTimeout(() => {
  if (speechSynth.getVoices().length > 0 && !tracyVoice) findTracyVoice();
}, 2000);

// 啟動
initVoiceNotification();
  
</script>
</body>
</html>











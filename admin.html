<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>後台管理 | Carter Dining</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    body { font-family: 'Microsoft JhengHei', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; margin: 0; }
    .admin-container { max-width: 1200px; margin: 2rem auto; padding: 1rem; }
    .panel { background: white; border-radius: 18px; padding: 1.8rem; box-shadow: 0 12px 35px rgba(0,0,0,0.12); margin-bottom: 2rem; position: relative; }
    .order-item { background: #f8f9fa; border-radius: 14px; padding: 1.2rem; margin-bottom: 1rem; border-left: 6px solid #e74c3c; transition: all 0.3s; }
    .order-item.completed { border-left-color: #27ae60; opacity: 0.85; }
    .order-item:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
    .badge-new { background: #e74c3c; animation: pulse 2s infinite; font-size: 0.8rem; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.7; } }
    .menu-item-admin { background: #f8f9fa; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; border-left: 4px solid #f39c12; }
    .image-upload { border: 3px dashed #ddd; border-radius: 14px; padding: 2.5rem; text-align: center; cursor: pointer; transition: all 0.3s; background: #f9f9f9; }
    .image-upload:hover { border-color: #e74c3c; background: #fff5f5; }
    .image-preview { max-height: 180px; object-fit: cover; border-radius: 12px; margin-top: 1rem; }
    .logout-btn { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    .print-btn { background: #2ecc71; color: white; }
    .print-btn:hover { background: #27ae60; }
  </style>
</head>
<body>

<!-- 登入畫面 -->
<div class="text-center p-5" id="loginScreen">
  <div class="card mx-auto shadow-lg" style="max-width: 420px;">
    <div class="card-body p-5">
      <h3 class="mb-4 text-primary"><i class="fas fa-shield-alt me-2"></i>管理員登入</h3>
      <div class="mb-3">
        <input type="email" class="form-control form-control-lg" id="loginEmail" value="admin@carterdining.com" placeholder="電郵">
      </div>
      <div class="mb-4">
        <input type="password" class="form-control form-control-lg" id="loginPassword" placeholder="密碼">
      </div>
      <button class="btn btn-primary btn-lg w-100" id="loginBtn">
        <span class="spinner-border spinner-border-sm me-2 d-none" id="loginSpinner"></span>
        登入後台
      </button>
      <div class="text-danger mt-3 fw-bold" id="loginError" style="display:none;"></div>
    </div>
  </div>
</div>

<!-- 主後台 -->
<div class="admin-container" id="adminPanel" style="display:none;">
  <button class="btn btn-outline-light btn-lg shadow logout-btn" id="logoutBtn">
    <i class="fas fa-sign-out-alt me-2"></i>登出
  </button>

  <!-- 即時訂單 -->
  <div class="panel">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="fas fa-bell text-danger me-2"></i>即時訂單 <span class="badge bg-danger" id="newOrderCount">0</span></h3>
      <button class="btn btn-warning btn-sm" onclick="printAllPending()">
        <i class="fas fa-print me-2"></i>列印全部新單
      </button>
    </div>
    <div id="ordersList">
      <p class="text-center text-muted py-5"><i class="fas fa-spinner fa-spin fa-2x"></i></p>
    </div>
  </div>

  <!-- 菜單管理 -->
  <div class="panel">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h3><i class="fas fa-utensils text-success me-2"></i>菜單管理</h3>
      <button class="btn btn-success btn-lg" onclick="showAddForm()">
        <i class="fas fa-plus me-2"></i>新增菜式
      </button>
    </div>

    <!-- 新增/編輯表單 -->
    <div id="menuFormContainer" class="border rounded-4 p-4 bg-light" style="display:none;">
      <form id="menuForm">
        <input type="hidden" id="editCat">
        <input type="hidden" id="editKey">
        <input type="hidden" id="oldImageUrl">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label fw-bold">分類</label>
            <select class="form-select" id="category">
              <option value="頭盤">頭盤</option>
              <option value="主食">主食</option>
              <option value="飲品">飲品</option>
            </select>
          </div>
          <div class="col-md-8">
            <label class="form-label fw-bold">菜名</label>
            <input type="text" class="form-control" id="title" required>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">價格 ($)</label>
            <input type="number" class="form-control" id="price" min="0" required>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">辣度</label>
            <input type="range" class="form-range" id="spice" min="0" max="3" value="0">
            <div class="d-flex justify-content-between small text-muted">
              <span>不辣</span><span>微辣</span><span>中辣</span><span>超辣</span>
            </div>
          </div>
          <div class="col-md-4">
            <label class="form-label fw-bold">標籤（可選）</label>
            <input type="text" class="form-control" id="label" placeholder="例：人氣、新品">
          </div>
          <div class="col-12">
            <label class="form-label fw-bold">描述</label>
            <textarea class="form-control" id="description" rows="2"></textarea>
          </div>
          <div class="col-12">
            <label class="form-label fw-bold">圖片</label>
            <div class="image-upload" id="dropZone">
              <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
              <p>拖曳圖片至此，或點擊上傳</p>
              <input type="file" id="imageInput" accept="image/*" style="display:none;">
            </div>
            <img id="imagePreview" class="image-preview w-100" style="display:none;" src="">
            <div class="progress mt-3" style="height:8px; display:none;">
              <div class="progress-bar" id="progressBar" style="width:0%"></div>
            </div>
            <small class="text-muted" id="uploadStatus"></small>
          </div>
          <div class="col-12 text-end mt-4">
            <button type="button" class="btn btn-secondary btn-lg me-3" onclick="hideForm()">取消</button>
            <button type="submit" class="btn btn-primary btn-lg px-5">
              <span id="saveBtnText">儲存菜式</span>
            </button>
          </div>
        </div>
      </form>
    </div>

    <div id="menuList" class="mt-4"></div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDXTIxs1g0nlXYybvzVWOQ5imVmRzffzLs",
    authDomain: "carter-dining-cf224.firebaseapp.com",
    databaseURL: "https://carter-dining-cf224-default-rtdb.firebaseio.com",
    projectId: "carter-dining-cf224",
    storageBucket: "carter-dining-cf224.firebasestorage.app",
    messagingSenderId: "416091581958",
    appId: "1:416091581958:web:3444dc94ef956d4b929d87"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage().ref();
  const menuRef = db.ref('menu');
  const ordersRef = db.ref('orders');

  let currentFile = null;
  let editCat = null, editKey = null, oldImageUrl = null;

  // 登入狀態
  auth.onAuthStateChanged(user => {
    if (user) {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('adminPanel').style.display = 'block';
      loadMenu();
      loadOrders();
      initVoice();
    } else {
      document.getElementById('loginScreen').style.display = 'block';
      document.getElementById('adminPanel').style.display = 'none';
    }
  });

  document.getElementById('loginBtn').onclick = () => {
    const email = document.getElementById('loginEmail').value.trim();
    const pass = document.getElementById('loginPassword').value;
    if (!email || !pass) return alert('請輸入電郵和密碼');
    document.getElementById('loginSpinner').classList.remove('d-none');
    auth.signInWithEmailAndPassword(email, pass)
      .catch(err => alert('登入失敗：' + err.message))
      .finally(() => document.getElementById('loginSpinner').classList.add('d-none'));
  };

  document.getElementById('logoutBtn').onclick = () => auth.signOut();

  // 菜單管理
  function loadMenu() {
    menuRef.on('value', snap => {
      const menu = snap.val() || {};
      renderMenuList(menu);
    });
  }

  function renderMenuList(menu) {
    const container = document.getElementById('menuList');
    container.innerHTML = '';
    const cats = ['頭盤', '主食', '飲品'];
    cats.forEach(cat => {
      if (!menu[cat]) return;
      const header = document.createElement('h5');
      header.className = 'mt-4 mb-3 text-primary fw-bold';
      header.textContent = cat;
      container.appendChild(header);
      Object.entries(menu[cat]).forEach(([key, item]) => {
        const div = document.createElement('div');
        div.className = 'menu-item-admin d-flex justify-content-between align-items-center';
        div.innerHTML = `
          <div>
            <strong>${item.title}</strong> $${item.price}
            ${item.label ? `<span class="badge bg-warning text-dark ms-2">${item.label}</span>` : ''}
            ${item.hidden ? `<span class="badge bg-secondary ms-2">隱藏</span>` : ''}
            ${item.soldOut ? `<span class="badge bg-danger ms-2">售完</span>` : ''}
          </div>
          <div>
            <button class="btn btn-sm btn-outline-primary me-1" onclick="editItem('${cat}','${key}')">編輯</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteItem('${cat}','${key}')">刪除</button>
          </div>
        `;
        container.appendChild(div);
      });
    });
  }

  window.showAddForm = () => {
    editCat = editKey = oldImageUrl = null;
    currentFile = null;
    document.getElementById('menuFormContainer').style.display = 'block';
    document.getElementById('menuForm').reset();
    document.getElementById('imagePreview').style.display = 'none';
    document.getElementById('saveBtnText').textContent = '新增菜式';
  };

  window.hideForm = () => document.getElementById('menuFormContainer').style.display = 'none';

  window.editItem = (cat, key) => {
    menuRef.child(cat).child(key).once('value', snap => {
      const item = snap.val();
      editCat = cat; editKey = key; oldImageUrl = item.image;
      document.getElementById('category').value = cat;
      document.getElementById('title').value = item.title;
      document.getElementById('price').value = item.price;
      document.getElementById('description').value = item.description || '';
      document.getElementById('spice').value = item.spice || 0;
      document.getElementById('label').value = item.label || '';
      if (item.image && !item.image.includes('placeholder')) {
        document.getElementById('imagePreview').src = item.image;
        document.getElementById('imagePreview').style.display = 'block';
      }
      document.getElementById('oldImageUrl').value = item.image || '';
      document.getElementById('saveBtnText').textContent = '更新菜式';
      document.getElementById('menuFormContainer').style.display = 'block';
    });
  };

  window.deleteItem = (cat, key) => confirm('確定永久刪除？') && menuRef.child(cat).child(key).remove();

  // 圖片上傳
  const dropZone = document.getElementById('dropZone');
  dropZone.onclick = () => document.getElementById('imageInput').click();
  dropZone.ondragover = e => { e.preventDefault(); dropZone.style.borderColor = '#e74c3c'; };
  dropZone.ondragleave = () => dropZone.style.borderColor = '#ddd';
  dropZone.ondrop = e => { e.preventDefault(); dropZone.style.borderColor = '#ddd'; if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); };
  document.getElementById('imageInput').onchange = e => e.target.files[0] && handleFile(e.target.files[0]);

  function handleFile(file) {
    if (!file.type.startsWith('image/')) return alert('請選擇圖片');
    currentFile = file;
    const reader = new FileReader();
    reader.onload = e => {
      document.getElementById('imagePreview').src = e.target.result;
      document.getElementById('imagePreview').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }

  // 儲存菜式
  document.getElementById('menuForm').onsubmit = async e => {
    e.preventDefault();
    const item = {
      title: document.getElementById('title').value.trim(),
      price: parseInt(document.getElementById('price').value),
      description: document.getElementById('description').value.trim(),
      spice: parseInt(document.getElementById('spice').value),
      label: document.getElementById('label').value.trim() || null,
      hidden: false,
      soldOut: false
    };

    let imageUrl = document.getElementById('oldImageUrl').value || 'https://via.placeholder.com/400?text=No+Image';

    if (currentFile) {
      const fileRef = storage.child(`menu-images/${Date.now()}_${currentFile.name}`);
      const task = fileRef.put(currentFile);
      task.on('state_changed', snap => {
        const pct = (snap.bytesTransferred / snap.totalBytes) * 100;
        document.querySelector('.progress').style.display = 'block';
        document.getElementById('progressBar').style.width = pct + '%';
      }, err => alert('上傳失敗'), async () => {
        imageUrl = await task.snapshot.ref.getDownloadURL();
        if (oldImageUrl && !oldImageUrl.includes('placeholder')) {
          storage.child(oldImageUrl.split('/o/')[1].split('?')[0]).delete().catch(() => {});
        }
        saveMenuItem(item, imageUrl);
      });
    } else {
      saveMenuItem(item, imageUrl);
    }
  };

  function saveMenuItem(item, imageUrl) {
    item.image = imageUrl;
    if (editCat && editKey) {
      menuRef.child(editCat).child(editKey).set(item).then(() => {
        alert('更新成功！');
        hideForm();
      });
    } else {
      menuRef.child(document.getElementById('category').value).push(item).then(() => {
        alert('新增成功！');
        hideForm();
      });
    }
  }

  // 訂單管理 + 語音
  let lastOrderCount = 0;
  function loadOrders() {
    ordersRef.on('value', snap => {
      const orders = snap.val() || {};
      const total = Object.keys(orders).length;
      const newCount = Object.values(orders).filter(o => o.status === 'new').length;
      document.getElementById('newOrderCount').textContent = newCount;

      if (total > lastOrderCount) {
        Object.entries(orders).forEach(([id, order]) => {
          if (order.status === 'new' && !order.notified) {
            ordersRef.child(id).update({ notified: true });
            speakNewOrder(order.table, order.notes || '');
          }
        });
      }
      lastOrderCount = total;
      renderOrders(orders);
    });
  }

  function renderOrders(orders) {
    const container = document.getElementById('ordersList');
    const list = Object.entries(orders).reverse();
    if (list.length === 0) {
      container.innerHTML = '<p class="text-center text-muted py-5">暫無訂單</p>';
      return;
    }
    container.innerHTML = '';
    list.forEach(([id, order]) => {
      const div = document.createElement('div');
      div.className = `order-item ${order.status === 'completed' ? 'completed' : ''}`;
      const time = new Date(order.timestamp).toLocaleString('zh-HK');
      let items = '', total = 0;
      order.items.forEach(i => {
        total += i.price * i.quantity;
        items += `<div class="small"><b>${i.title}</b> ×${i.quantity} = $${i.price * i.quantity}</div>`;
      });
      div.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <strong class="fs-5">#${order.table}</strong>
            ${order.status === 'new' ? '<span class="badge badge-new ms-2">新訂單</span>' : '<span class="badge bg-success">已完成</span>'}
            <small class="text-muted d-block">${time}</small>
          </div>
          <div>
            ${order.status === 'new' ? `<button class="btn btn-success btn-sm me-2" onclick="completeOrder('${id}')">完成</button>` : ''}
            <button class="btn btn-outline-danger btn-sm" onclick="deleteOrder('${id}')">刪除</button>
          </div>
        </div>
        <div class="mt-3">${items}</div>
        <div class="fw-bold mt-2 fs-5 text-primary">總計 $${total}</div>
        ${order.notes ? `<div class="text-muted mt-2"><strong>備註：</strong>${order.notes}</div>` : ''}
      `;
      container.appendChild(div);
    });
  }

  window.completeOrder = id => ordersRef.child(id).update({ status: 'completed' });
  window.deleteOrder = id => confirm('確定刪除？') && ordersRef.child(id).remove();

  // 最穩 Tracy 語音
  let voiceReady = false;
  function initVoice() {
    setTimeout(() => speechSynthesis.getVoices(), 1000);
  }
  function speakNewOrder(table, notes) {
    if (!voiceReady && !confirm("點擊「確定」解鎖 Tracy 甜美粵語語音（只需一次）")) return;
    voiceReady = true;

    notes = notes.replace(/\n/g, '，').replace(/[\u{1F600}-\u{1F6FF}]/gu, '');
    const msg = table.includes('取餐') ? `外賣新訂單，取餐號碼 ${table.replace('取餐 ', '')}` : `${table} 有新訂單${notes ? '，備註 ' + notes : ''}`;

    const utter = new SpeechSynthesisUtterance("叮咚！" + msg);
    const voices = speechSynthesis.getVoices();
    const tracy = voices.find(v => v.lang.startsWith('zh-HK') && (v.name.includes('Tracy') || v.name.includes('曉彤'))) 
                  || voices.find(v => v.lang.startsWith('zh'));
    if (tracy) utter.voice = tracy;
    utter.lang = 'zh-HK';
    utter.rate = 1.0;
    speechSynthesis.cancel();
    speechSynthesis.speak(utter);
  }
</script>
</body>
</html>











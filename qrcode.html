<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Carter Dining | 線上點餐</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <style>
    :root{--p:#e74c3c;--s:#f39c12;}
    body{font-family:'Microsoft JhengHei',sans-serif;background:linear-gradient(135deg,#f5f7fa,#c3cfe2);min-height:100vh;padding-bottom:120px;}
    .hero{background:linear-gradient(rgba(0,0,0,.6),rgba(0,0,0,.6)),url('data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 1200 600%22><rect fill=%22%23e74c3c%22 width=%221200%22 height=%22600%22/><text x=%22600%22 y=%22300%22 font-size=%2280%22 fill=%22white%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22>Carter Dining</text></svg>') center/cover;color:white;padding:7rem 0 5rem;text-align:center;}
    .menu-item{background:white;border-radius:18px;overflow:hidden;box-shadow:0 8px 25px rgba(0,0,0,.12);transition:.3s;}
    .menu-item:hover{transform:translateY(-8px);box-shadow:0 15px 40px rgba(0,0,0,.2);}
    .item-img{height:180px;background:#eee;background-size:cover;background-position:center;position:relative;}
    .item-img::after{content:attr(data-label);position:absolute;bottom:0;left:0;background:rgba(231,76,60,.9);color:white;padding:6px 14px;font-size:13px;border-radius:0 12px 0 0;}
    .soldout-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.85);color:white;padding:15px 35px;border-radius:50px;font-weight:bold;font-size:20px;}
    .quantity-control{display:flex;align-items:center;gap:12px;margin:12px 0;}
    .quantity-btn{width:44px;height:44px;border:3px solid var(--s);background:white;color:var(--s);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;}
    .quantity-btn:hover{background:var(--s);color:white;}
    .quantity-input{width:70px;text-align:center;border:2px solid #ddd;border-radius:12px;padding:8px;font-weight:bold;font-size:18px;}
    .add-to-cart{background:var(--p);color:white;border:none;padding:12px;border-radius:30px;font-weight:bold;width:100%;}
    .add-to-cart:hover{background:#c0392b;}
    .cart-toggle{position:fixed;bottom:30px;right:20px;width:70px;height:70px;background:var(--p);color:white;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 25px rgba(231,76,60,.5);font-size:30px;z-index:1000;}
    .cart-badge{position:absolute;top:-8px;right:-8px;background:#e74c3c;color:white;border-radius:50%;width:30px;height:30px;font-size:14px;display:flex;align-items:center;justify-content:center;}
    .cart-summary{position:fixed;bottom:0;left:0;right:0;background:white;box-shadow:0 -10px 30px rgba(0,0,0,.15);padding:1.5rem;border-radius:25px 25px 0 0;transform:translateY(100%);transition:.4s;z-index:999;}
  </style>
</head>
<body>

<div class="hero">
  <div class="container">
    <h1 class="display-4 fw-bold">歡迎來到 Carter Dining</h1>
    <p class="lead mt-3">掃碼點餐，輕鬆堂食或自取</p>
    <a href="#menu" class="btn btn-warning btn-lg mt-4 px-5 py-3 fw-bold">立即點餐</a>
  </div>
</div>

<div class="container my-5" id="menu">
  <div class="text-center py-5 text-muted">
    <i class="fas fa-spinner fa-spin fa-3x"></i><p class="mt-3">載入菜單中...</p>
  </div>
</div>

<div class="cart-toggle" id="cartToggle">
  <i class="fas fa-shopping-cart"></i>
  <span class="cart-badge" id="cartBadge">0</span>
</div>

<div class="cart-summary" id="cartSummary">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">購物車</h5>
      <button class="btn btn-sm btn-outline-secondary" id="clearCart">清空</button>
    </div>
    <div id="cartItems" class="mb-3"></div>
    <div class="fs-4 fw-bold text-end mb-3">總計: $<span id="cartTotal">0</span></div>
    <button class="btn btn-danger btn-lg w-100" id="checkoutBtn" data-bs-toggle="modal" data-bs-target="#checkoutModal">去結帳</button>
  </div>
</div>

<!-- 結帳 Modal -->
<div class="modal fade" id="checkoutModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title">確認訂單</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label fw-bold">用餐方式</label>
          <select class="form-select" id="diningMethod">
            <option value="dinein">堂食</option>
            <option value="takeaway">外賣自取</option>
          </select>
        </div>
        <div id="dineinSection">
          <label class="form-label fw-bold">桌號</label>
          <input type="text" class="form-control" id="tableNumber" placeholder="例如：A1、B3" maxlength="5">
        </div>
        <div id="takeawaySection" style="display:none;">
          <label class="form-label fw-bold">取餐號碼</label>
          <div class="fs-3 fw-bold text-center text-primary" id="pickupNumber">--</div>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">備註</label>
          <textarea class="form-control" rows="2" id="orderNotes" placeholder="例如：不要蔥、少辣"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
        <button type="button" class="btn btn-primary px-5" id="confirmOrder">提交訂單</button>
      </div>
    </div>
  </div>
</div>

<!-- 成功 Modal -->
<div class="modal fade" id="successModal">
  <div class="modal-dialog modal-sm">
    <div class="modal-content text-center">
      <div class="modal-body py-5">
        <i class="fas fa-check-circle text-success fa-4x mb-4"></i>
        <h3 class="fw-bold">訂單已提交！</h3>
        <div class="fs-2 fw-bold text-primary my-4" id="finalPickupNumber"></div>
        <p class="text-muted" id="successMessage"></p>
        <button class="btn btn-primary px-5" data-bs-dismiss="modal">完成</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const firebaseConfig = { apiKey: "AIzaSyDXTIxs1g0nlXYybvzVWOQ5imVmRzffzLs", authDomain: "carter-dining-cf224.firebaseapp.com", projectId: "carter-dining-cf224", storageBucket: "carter-dining-cf224.firebasestorage.app", messagingSenderId: "416091581958", appId: "1:416091581958:web:3444dc94ef956d4b929d87" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let cart = [], pickupCounter = 1;
  const els = { cartBadge: document.getElementById('cartBadge'), cartItems: document.getElementById('cartItems'), cartTotal: document.getElementById('cartTotal'), cartSummary: document.getElementById('cartSummary'), cartToggle: document.getElementById('cartToggle'), diningMethod: document.getElementById('diningMethod'), dineinSection: document.getElementById('dineinSection'), takeawaySection: document.getElementById('takeawaySection'), pickupNumber: document.getElementById('pickupNumber'), tableNumber: document.getElementById('tableNumber'), orderNotes: document.getElementById('orderNotes') };

  // 載入菜單
  async function loadMenu() {
    const snapshot = await db.collection('menu').orderBy('order').get();
    const container = document.getElementById('menu');
    container.innerHTML = '';
    const categories = {};
    snapshot.forEach(doc => {
      const item = doc.data();
      if (item.hidden || item.soldOut) return;
      if (!categories[item.category]) categories[item.category] = [];
      categories[item.category].push({ ...item, id: doc.id });
    });
    Object.keys(categories).forEach(cat => {
      container.innerHTML += `<div class="mb-5"><h2 class="h4 fw-bold mb-4 text-primary">${cat}</h2><div class="row g-4"></div></div>`;
      const row = container.lastElementChild.querySelector('.row');
      categories[cat].forEach(item => {
        row.innerHTML += `
          <div class="col-6 col-md-4 col-lg-3">
            <div class="menu-item">
              <div class="item-img" style="background-image:url('${item.image || 'https://via.placeholder.com/400'}')" data-label="${item.label || ''}"></div>
              <div class="p-3">
                <h5 class="fw-bold">${item.title}</h5>
                <p class="text-muted small">${item.description || ''}</p>
                <div class="text-danger fw-bold fs-5 mb-2">$${item.price}</div>
                <div class="quantity-control">
                  <div class="quantity-btn minus">−</div>
                  <input type="text" class="quantity-input" value="0" readonly>
                  <div class="quantity-btn plus">+</div>
                </div>
                <button class="add-to-cart w-100 mt-2">加入購物車</button>
              </div>
            </div>
          </div>`;
      });
    });
    bindEvents();
  }

  function bindEvents() {
    document.querySelectorAll('.quantity-control').forEach(ctrl => {
      const minus = ctrl.querySelector('.minus'), plus = ctrl.querySelector('.plus'), input = ctrl.querySelector('.quantity-input'), btn = ctrl.closest('.menu-item').querySelector('.add-to-cart');
      plus.onclick = () => { input.value = +input.value + 1; btn.textContent = `加入 (${input.value})`; };
      minus.onclick = () => { if (+input.value > 0) { input.value = +input.value - 1; btn.textContent = input.value > 0 ? `加入 (${input.value})` : '加入購物車'; }};
      btn.onclick = () => {
        const qty = +input.value;
        if (qty === 0) return;
        const title = ctrl.closest('.menu-item').querySelector('h5').textContent;
        const price = parseInt(ctrl.closest('.menu-item').querySelector('.fs-5').textContent.replace('$',''));
        const existing = cart.find(i => i.title === title);
        existing ? existing.quantity += qty : cart.push({ title, price, quantity: qty });
        input.value = 0; btn.textContent = '已加入！'; btn.style.background = '#27ae60';
        setTimeout(() => { btn.textContent = '加入購物車'; btn.style.background = ''; }, 1000);
        updateCart();
      };
    });
  }

  function updateCart() {
    const totalItems = cart.reduce((s,i)=>s+i.quantity,0);
    const totalPrice = cart.reduce((s,i)=>s+i.price*i.quantity,0);
    els.cartBadge.textContent = totalItems;
    els.cartTotal.textContent = totalPrice;
    els.cartItems.innerHTML = cart.length === 0 ? '<p class="text-center text-muted py-4">購物車是空的</p>' : cart.map((item,i) => `
      <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
        <div><div class="fw-bold">${item.title}</div><small class="text-muted">×${item.quantity}</small></div>
        <div class="text-end"><div class="fw-bold">$${item.price * item.quantity}</div>
        <i class="fas fa-times text-danger ms-3" style="cursor:pointer" onclick="cart.splice(${i},1);updateCart();"></i></div>
      </div>`).join('');
  }

  els.cartToggle.onclick = () => els.cartSummary.style.transform = els.cartSummary.style.transform.includes('100%') ? 'translateY(0)' : 'translateY(100%)';
  document.getElementById('clearCart').onclick = () => { cart=[]; updateCart(); };

  els.diningMethod.onchange = () => {
    if (els.diningMethod.value === 'takeaway') {
      els.dineinSection.style.display = 'none';
      els.takeawaySection.style.display = 'block';
      els.pickupNumber.textContent = String(pickupCounter).padStart(3,'0');
    } else {
      els.dineinSection.style.display = 'block';
      els.takeawaySection.style.display = 'none';
    }
  };

  document.getElementById('confirmOrder').onclick = async () => {
    if (cart.length === 0) return alert('購物車是空的！');
    if (els.diningMethod.value === 'dinein' && !els.tableNumber.value.trim()) return alert('請輸入桌號！');

    const btn = document.getElementById('confirmOrder');
    btn.disabled = true; btn.innerHTML = '傳送中...';

    const order = {
      timestamp: Date.now(),
      method: els.diningMethod.value,
      table: els.diningMethod.value === 'dinein' ? els.tableNumber.value.trim() : `取餐 ${String(pickupCounter).padStart(3,'0')}`,
      items: cart,
      notes: els.orderNotes.value.trim(),
      status: 'new',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try {
      await db.collection('orders').add(order);
      pickupCounter++;
      cart = []; updateCart();
      els.cartSummary.style.transform = 'translateY(100%)';
      document.getElementById('finalPickupNumber').textContent = order.table;
      document.getElementById('successMessage').innerHTML = order.method === 'takeaway' ? `您的取餐號碼是 <strong>${order.table}</strong>` : `餐點將送至 <strong>${order.table}</strong>`;
      bootstrap.Modal.getInstance(document.getElementById('checkoutModal')).hide();
      new bootstrap.Modal(document.getElementById('successModal')).show();
    } catch (err) {
      alert('訂單傳送失敗！請直接告訴店員。\n錯誤：' + err.message);
    } finally {
      btn.disabled = false; btn.innerHTML = '提交訂單';
    }
  };

  loadMenu(); updateCart();
</script>
</body>
</html>







